---
import type { GetStaticPaths } from "astro";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogPostCard from "../../components/BlogPostCard.astro";
import { withBase } from "../../lib/utils";
import { getCollection } from "astro:content";

export const prerender = true;

export const getStaticPaths: GetStaticPaths = async () => {
  const allPosts = await getCollection("posts");
  const publishedPosts = allPosts.filter((p) => p.data.published);

  const tagMap = new Map<string, typeof publishedPosts>();
  for (const post of publishedPosts) {
    for (const tag of post.data.tags) {
      if (!tagMap.has(tag)) tagMap.set(tag, []);
      tagMap.get(tag)!.push(post);
    }
  }

  return [...tagMap.entries()].map(([tag, posts]) => ({
    params: { tag },
    props: {
      tag,
      posts: posts.sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime()),
    },
  }));
};

interface Props { tag: string; posts: CollectionEntry<"posts">[] }
const { tag, posts } = Astro.props;
---

<BaseLayout title={`Posts tagged "${tag}" | Python Insider`}>
  <div class="animate-fade-up">
    <a
      href={withBase("/tags")}
      class="group inline-flex items-center gap-1.5 text-sm font-medium text-[#306998] transition-colors hover:text-[#254f73] dark:text-[#ffd43b] dark:hover:text-[#f0c419]"
    >
      <span class="transition-transform group-hover:-translate-x-0.5">&larr;</span>
      All tags
    </a>
    <h1 class="mt-3 text-3xl font-bold text-zinc-900 dark:text-zinc-100" style="font-family: var(--font-display); letter-spacing: -0.02em;">
      Posts tagged &ldquo;<span class="text-[#306998] dark:text-[#ffd43b]">{tag}</span>&rdquo;
    </h1>
    <p class="mt-2 text-sm text-zinc-500 dark:text-zinc-400">{posts.length} {posts.length === 1 ? "post" : "posts"}</p>
  </div>

  <div class="mt-8 animate-fade-up stagger-2">
    <div class="divide-y divide-zinc-200 dark:divide-zinc-800">
      {posts.map((post: any) => (
        <BlogPostCard
          slug={post.id}
          title={post.data.title}
          publishDate={post.data.publishDate.toISOString()}
          author={post.data.author}
          description={post.data.description}
          tags={post.data.tags}
        />
      ))}
    </div>
  </div>
</BaseLayout>
